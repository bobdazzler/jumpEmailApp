<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title th:text="'Category: ' + ${category.name}">Category View</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>
<body class="bg-light">
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
        <a class="navbar-brand" href="/home">Jump AI Email Sorter</a>
        <div class="navbar-nav ms-auto">
            <span class="nav-link text-light">Welcome, <strong th:text="${userName}"></strong></span>
            <a class="nav-link btn btn-outline-light btn-sm" href="/logout">Logout</a>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 th:text="${category.name}">Category</h2>
            <p class="text-muted" th:text="${category.description}">Description</p>
        </div>
        <a href="/home" class="btn btn-outline-secondary">‚Üê Back to Dashboard</a>
    </div>

    <div x-data="{ selectedEmails: [] }">
        <div class="card mb-3" th:if="${emails != null and !emails.isEmpty()}">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span th:text="${emails.size()} + ' email(s)'"></span>
                <div>
                    <button class="btn btn-sm btn-outline-primary me-2" 
                            @click="selectedEmails = []; document.querySelectorAll('input[type=checkbox]').forEach(c => { c.checked = false; })">
                        Clear Selection
                    </button>
                    <button class="btn btn-sm btn-primary me-2"
                            @click="selectedEmails = Array.from(document.querySelectorAll('input[type=checkbox]:checked')).map(c => c.value)"
                            th:disabled="${emails.isEmpty()}"
                            x-show="selectedEmails.length === 0"
                            onclick="selectAllEmails(this)">
                        Select All
                    </button>
                </div>
            </div>
        </div>

        <div th:if="${emails == null or emails.isEmpty()}" class="alert alert-info">
            No emails in this category yet. New emails matching this category's description will appear here automatically.
        </div>

        <div class="card mb-3" x-show="selectedEmails.length > 0" style="display: none;">
            <div class="card-body">
                <strong x-text="selectedEmails.length + ' email(s) selected'"></strong>
                <div class="mt-2">
                    <form method="post" th:action="@{/bulk/delete}" style="display: inline;" 
                          onsubmit="const form = event.target; const emailIds = document.querySelectorAll('input[type=checkbox]:checked'); const ids = Array.from(emailIds).map(c => c.value).join(','); form.querySelector('input[name=emailIds]').value = ids; return confirm('Are you sure you want to delete the selected emails?')">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        <input type="hidden" name="emailIds" value="">
                        <button type="submit" class="btn btn-danger btn-sm">Delete Selected</button>
                    </form>
                    <form method="post" th:action="@{/bulk/unsubscribe}" style="display: inline;" class="ms-2"
                          onsubmit="const form = event.target; const emailIds = document.querySelectorAll('input[type=checkbox]:checked'); const ids = Array.from(emailIds).map(c => c.value).join(','); form.querySelector('input[name=emailIds]').value = ids; return confirm('This will attempt to unsubscribe from the selected emails. Continue?')">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        <input type="hidden" name="emailIds" value="">
                        <button type="submit" class="btn btn-warning btn-sm">Unsubscribe Selected</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="list-group">
            <div th:each="email : ${emails}" class="list-group-item">
                <div class="form-check mb-2">
                    <input class="form-check-input email-checkbox" type="checkbox" 
                           th:value="${email.id}"
                           @change="selectedEmails = Array.from(document.querySelectorAll('.email-checkbox:checked')).map(c => c.value)"
                           th:id="'email-' + ${email.id}">
                    <label class="form-check-label" th:for="'email-' + ${email.id}">
                        <strong>Select</strong>
                    </label>
                </div>
                
                <div class="ms-4">
                    <h6 class="mb-2">
                        <a th:href="@{/email/{id}(id=${email.id})}" th:text="'Email #' + ${email.id}">Email</a>
                    </h6>
                    <p class="text-muted small mb-2" th:text="${email.summary}">Summary</p>
                    <small class="text-muted">Gmail ID: <code th:text="${email.gmailId}"></code></small>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function selectAllEmails(button) {
    document.querySelectorAll('.email-checkbox').forEach(c => c.checked = true);
    const checked = Array.from(document.querySelectorAll('.email-checkbox:checked')).map(c => c.value);
    const alpineData = Alpine.$data(document.querySelector('[x-data]'));
    if (alpineData) {
        alpineData.selectedEmails = checked;
    }
    button.style.display = 'none';
}
</script>
</body>
</html>
